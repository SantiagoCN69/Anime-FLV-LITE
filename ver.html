<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reproductor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" sizes="256x256" href="icon.png">
    <link rel="stylesheet" href="style.css">
</head>
<body>
  <a href="" id="btn-volver-anime" class="btn-volver">&#10094;</a>
  <button id="btn-bloquear-anuncios" class="btn-anuncios" title="Si necesitas un servidor que no funcione debido al AdBlock, puedes desactivarlo.">AdBlock: OFF</button>
  <button id="btn-censura" class="btn-censura">Censura: OFF</button>
  <a href="" id="btn-siguiente-capitulo" class="btn-siguiente">&#10095;</a>

  <div class="reproductor-container">
    <div id="video"></div>
    <div id="controles"></div>
  </div>
  <script>
    // Obtener links de embed directamente del parámetro de la URL (esperando que sea un JSON codificado en base64)
    const params = new URLSearchParams(location.search);
    let embeds = params.get('embeds');
    const animeId = params.get('animeId') || '';
    const episodioActual = parseInt(params.get('episodio') || '1');
    const siguienteEpisodio = episodioActual + 1;
    
    // Configurar botón de volver
    const btnVolver = document.getElementById('btn-volver-anime');
    btnVolver.href = `anime.html?id=${animeId}`;

    // Configurar botón de siguiente capítulo
    const btnSiguienteCapitulo = document.getElementById('btn-siguiente-capitulo');
    btnSiguienteCapitulo.href = `ver.html?id=${animeId}&episodio=${siguienteEpisodio}&embeds=${embeds}`;
    
    // Ocultar botón si no hay siguiente capítulo (esto se puede mejorar después)
    if (!embeds) {
      btnSiguienteCapitulo.style.display = 'none';
    }

    // Configurar botón de Censura
    let censuraActiva = false;
    const btnCensura = document.getElementById('btn-censura');
    const reproductorContainer = document.querySelector('.reproductor-container');
    btnCensura.addEventListener('click', () => {
      censuraActiva = !censuraActiva;
      btnCensura.textContent = `Censura: ${censuraActiva ? 'ON' : 'OFF'}`;
      reproductorContainer.classList.toggle('censure', censuraActiva);
    });

    // Configurar botón de AdBlock
    let bloquearAnuncios = true;
    const btnBloquearAnuncios = document.getElementById('btn-bloquear-anuncios');
    btnBloquearAnuncios.textContent = 'AdBlock: ON';
    btnBloquearAnuncios.addEventListener('click', () => {
      bloquearAnuncios = !bloquearAnuncios;
      btnBloquearAnuncios.textContent = `AdBlock: ${bloquearAnuncios ? 'ON' : 'OFF'}`;
      // Si hay un iframe actual, volver a cargarlo con la configuración actual
      const videoDiv = document.getElementById('video');
      const currentIframe = videoDiv.querySelector('iframe');
      if (currentIframe) {
        const currentSrc = currentIframe.src;
        // Encontrar el botón actualmente seleccionado
        const botonesServidor = document.querySelectorAll('#controles button');
        const botonActivo = Array.from(botonesServidor).find(btn => btn.classList.contains('servidor-activo'));
        
        videoDiv.innerHTML = '';
        mostrarVideo(currentSrc, botonActivo);
      }
    });

    if (!embeds) {
      document.getElementById('video').innerHTML = 'No se encontraron enlaces de video.';
      throw new Error('Faltan los enlaces de video');
    }
    try {
      embeds = JSON.parse(atob(embeds));
    } catch (e) {
      document.getElementById('video').innerHTML = 'Enlaces de video inválidos.';
      throw new Error('Formato de enlaces inválido');
    }
    if (!Array.isArray(embeds) || embeds.length === 0) {
      document.getElementById('video').innerHTML = 'No se encontraron enlaces de video.';
      throw new Error('Array de enlaces vacío');
    }

    // Mostrar el tercer embed por defecto (índice 2)
    // Mostrar botones para cambiar de servidor
    let botones = '';
    embeds.forEach((srv, idx) => {
      botones += `<button onclick="mostrarVideo('${srv}', this)">Servidor ${idx + 1}</button> `;
    });
    document.getElementById('controles').innerHTML = botones;

    // Seleccionar y marcar el tercer botón
    const botonesSerie = document.querySelectorAll('#controles button');
    const tercerBoton = botonesSerie[2];
    tercerBoton.classList.add('servidor-activo');

    // Mostrar el tercer embed
    mostrarVideo(embeds[2], tercerBoton);

    function mostrarVideo(link, botonSeleccionado) {
      // Quitar clase activa de todos los botones
      const todosLosBotones = document.querySelectorAll('#controles button');
      todosLosBotones.forEach(btn => btn.classList.remove('servidor-activo'));
      
      // Agregar clase activa al botón seleccionado
      if (botonSeleccionado) {
        botonSeleccionado.classList.add('servidor-activo');
      }

      document.getElementById('video').innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.src = link;
      iframe.width = '100%';
      iframe.height = '100%';
      iframe.frameBorder = '0';
      iframe.allowFullscreen = true;
      iframe.scrolling = 'no';
      
      // Configurar sandbox según el estado de bloqueo de anuncios
      if (!bloquearAnuncios) {
        // Cuando AdBlock está OFF, eliminar todas las restricciones
        iframe.removeAttribute('sandbox');
      } else {
        // Cuando AdBlock está ON, mantener restricciones
        iframe.sandbox = 'allow-scripts allow-same-origin allow-forms';
      }
      
      document.getElementById('video').appendChild(iframe);
      
      // Agregar evento de doble clic para pantalla completa
      iframe.addEventListener('dblclick', () => {
        if (!document.fullscreenElement) {
          if (iframe.requestFullscreen) {
            iframe.requestFullscreen();
          } else if (iframe.mozRequestFullScreen) { // Firefox
            iframe.mozRequestFullScreen();
          } else if (iframe.webkitRequestFullscreen) { // Chrome, Safari and Opera
            iframe.webkitRequestFullscreen();
          } else if (iframe.msRequestFullscreen) { // Internet Explorer/Edge
            iframe.msRequestFullscreen();
          }
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.mozCancelFullScreen) { // Firefox
            document.mozCancelFullScreen();
          } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) { // Internet Explorer/Edge
            document.msExitFullscreen();
          }
        }
      });
    }
  </script>
</body>
</html>