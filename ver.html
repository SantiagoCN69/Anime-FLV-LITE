<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reproductor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="icon.png" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <a href="#" id="btn-volver-anime" class="btn-volver">&#10094;</a>
  <a href="#" id="btn-anterior-capitulo" class="btn-anterior">&#10094; Anterior Cap</a>
  <a href="#" id="btn-cap" class="btn-cap">Capítulo</a>
  <a href="#" id="btn-siguiente-capitulo" class="btn-siguiente">Siguiente Cap &#10095;</a>
  <button id="btn-bloquear-anuncios" class="btn-anuncios">AdBlock: ON</button>
  <button id="btn-censura" class="btn-censura">Censura: OFF</button>

  <div class="reproductor-container">
    <div id="video"></div>
    <div id="controles"></div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const animeId = params.get("animeId");
    const episodioUrl = decodeURIComponent(params.get("url") || "");
    const btnVolver = document.getElementById("btn-volver-anime");
    btnVolver.href = `anime.html?id=${animeId}`;

    const btnSiguiente = document.getElementById("btn-siguiente-capitulo");
    const btnAnterior = document.getElementById("btn-anterior-capitulo");

    let episodios = [];
    let episodioActualIndex = -1;
    let embeds = [];
    let bloquearAnuncios = true;
    let censuraActiva = false;

    const btnBloquear = document.getElementById("btn-bloquear-anuncios");
    const btnCensura = document.getElementById("btn-censura");
    const reproductorContainer = document.querySelector(".reproductor-container");

    btnBloquear.addEventListener("click", () => {
      bloquearAnuncios = !bloquearAnuncios;
      btnBloquear.textContent = `AdBlock: ${bloquearAnuncios ? "ON" : "OFF"}`;
      btnBloquear.classList.toggle("activo", bloquearAnuncios);
      const iframe = document.querySelector("#video iframe");
      const servidorActivo = document.querySelector("#controles .servidor-activo");
      if (iframe) mostrarVideo(iframe.src, servidorActivo);
    });

    btnCensura.addEventListener("click", () => {
      censuraActiva = !censuraActiva;
      btnCensura.textContent = `Censura: ${censuraActiva ? "ON" : "OFF"}`;
      btnCensura.classList.toggle("activo", censuraActiva);
      reproductorContainer.classList.toggle("censure", censuraActiva);
    });

    async function cargarEpisodios() {
      try {
        const res = await fetch(`https://backend-animeflv-lite.onrender.com/api/episodes?id=${animeId}`);
        const data = await res.json();
        episodios = data.episodes;
        episodioActualIndex = episodios.findIndex(ep => ep.url === episodioUrl);
        if (episodioActualIndex === -1) throw new Error("Episodio no encontrado");
        await cargarVideoDesdeEpisodio(episodioActualIndex);
        return episodios;
      } catch (err) {
        document.getElementById("video").innerHTML = "Error al cargar episodio.";
        console.error(err);
        return [];
      }
    }

    async function cargarVideoDesdeEpisodio(index) {
      const ep = episodios[index];
      const res = await fetch(`https://backend-animeflv-lite.onrender.com/api/episode?url=${encodeURIComponent(ep.url)}`);
      const data = await res.json();
      if (!data.servidores || !data.servidores.length) {
        document.getElementById("video").innerHTML = "No se encontraron servidores.";
        return;
      }

      embeds = data.servidores;
      episodioActualIndex = index;

      // Actualizar botón de capítulo
      const btnCap = document.getElementById("btn-cap");
      btnCap.textContent = `Capítulo ${ep.number || ep.title || "desconocido"}`;

      history.replaceState({}, "", `ver.html?animeId=${animeId}&url=${encodeURIComponent(ep.url)}`);

      const controles = document.getElementById("controles");
      controles.innerHTML = "";
      embeds.forEach((srv, i) => {
        const btn = document.createElement("button");
        btn.textContent = `Servidor ${i + 1}`;
        btn.onclick = () => mostrarVideo(srv, btn);
        controles.appendChild(btn);
      });

      mostrarVideo(embeds[0], controles.querySelector("button"));
      return ep;
    }

    function mostrarVideo(link, botonSeleccionado) {
      const botones = document.querySelectorAll("#controles button");
      botones.forEach(btn => btn.classList.remove("servidor-activo"));
      if (botonSeleccionado) botonSeleccionado.classList.add("servidor-activo");

      const videoDiv = document.getElementById("video");
      videoDiv.innerHTML = "";
      const iframe = document.createElement("iframe");
      iframe.src = link;
      iframe.width = "100%";
      iframe.height = "100%";
      iframe.frameBorder = "0";
      iframe.allowFullscreen = true;
      iframe.scrolling = "no";

      if (!bloquearAnuncios) {
        iframe.removeAttribute("sandbox");
      } else {
        iframe.sandbox = "allow-scripts allow-same-origin allow-forms";
      }

      videoDiv.appendChild(iframe);
    }

    function actualizarEstadoBotones() {
      // Deshabilitar botón anterior si es el primer episodio
      btnAnterior.disabled = episodioActualIndex <= 0;
      btnAnterior.classList.toggle('desactivado', episodioActualIndex <= 0);

      // Deshabilitar botón siguiente si es el último episodio
      btnSiguiente.disabled = episodioActualIndex >= episodios.length - 1;
      btnSiguiente.classList.toggle('desactivado', episodioActualIndex >= episodios.length - 1);
    }

    btnSiguiente.addEventListener("click", e => {
      e.preventDefault();
      if (episodioActualIndex < episodios.length - 1) {
        cargarVideoDesdeEpisodio(episodioActualIndex + 1).then(actualizarEstadoBotones);
      }
    });

    btnAnterior.addEventListener("click", e => {
      e.preventDefault();
      if (episodioActualIndex > 0) {
        cargarVideoDesdeEpisodio(episodioActualIndex - 1).then(actualizarEstadoBotones);
      }
    });

    cargarEpisodios().then(actualizarEstadoBotones);
  </script>
</body>
</html>
